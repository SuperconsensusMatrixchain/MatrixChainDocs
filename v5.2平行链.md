Xuper5.2平行链文档
============

1. 背景
--------
**基于合约事件的异步任务机制** 旨在在xupercore中提供一套类似于老xuperchain(v3.12前)的二代合约功能，使交易不走“**预执行-执行**”模式，而直接是待收到区块时，统一仅执行一次。

这样做的原因是防止交易Tx副作用，比如创建平行链场景，“预执行-执行”模式会两次都创建一条平行链。

**新增功能**
* **平行链功能**
	
  相对于主链而言，运行在 XuperChain 中的用户级区块链实例，用户通过调用主链的智能合约创建。功能与主链无区别，全网节点均可以获取平行链账本数据，实现整体架构水平可扩展。
  
  * 简单xchain网络的平行链创建、平行链停用
    * 平行链创建时可指定群组，若不指定，默认创建者为群组唯一管理员
  
* **群组功能**
	
  作用于平行链，具备群组特性的平行链，只有特定节点才拥有该平行链的账本数据。群组具备的特性包括私密性、动态性。群组中可以添加地址信息，并且这些信息可以互相共享平行链。同时群组有 admin 权限，admin 可以有权限向群组中添加、删除成员。
  
  * 群组只能在创建平行链时创建，标明该链所属管理员和查看权限
    * 群组中有Admin字段表明谁有权限修改群组
    * Identities字段表明谁有权限查看群组和平行链
  
* 平行链和群组构成了完整的平行链及平行链权限功能
	* 若要求平行链只能规定节点同步，需在xchain节点上增加xfront代理
    
    
2. 指令
--------
**2.1 所有指令通过如下三代kernel合约调用**
* 字符串“$parachain”实际上是平行链群组的CONTRACT_NAME

``` shell
./bin/xchain-cli xkernel invoke '$parachain' --method {$METHOD}
```
**2.2 创建平行链**

* 所有创建平行链按照如下格式
``` shell
./bin/xchain-cli xkernel invoke '$parachain' --method createChain -a  {$GENESIS_CONFIG} --fee {$FEE} -H {$PORT} 
```
* 参数需要包括

	``` json
	{
    	"name": {$BCNAME}, #链名，需主链上唯一
      "data": {$GENESIS_CONFIG},	# 创世块配置
      "group": {$GROUP_CONFIG}	# 群组配置
	}
	```
	
* 下面是一个创建single共识平行链hello的例子, 群组为默认创建者
``` shell
./bin/xchain-cli xkernel invoke '$parachain' --method createChain -a '{"name": "hello","data": "{\"version\":\"1\",\"predistribution\":[{\"address\":\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"quota\":\"100000000000000000000\"}],\"maxblocksize\":\"128\",\"award\":\"1000000\",\"decimals\":\"8\",\"award_decay\":{\"height_gap\":31536000,\"ratio\":1},\"gas_price\":{\"cpu_rate\":1000,\"mem_rate\":1000000,\"disk_rate\":1,\"xfee_rate\":1},\"new_account_resource_amount\":1000,\"genesis_consensus\":{\"name\":\"single\",\"config\":{\"miner\":\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"period\":\"3000\"}}}"}' --fee 10000000000
```

* 下面是一个创建**single共识平行链**hi的例子, 创建时**指定了群组**
``` shell
./bin/xchain-cli xkernel invoke '$parachain' --method createChain -a '{"name": "hi","data": "{\"version\":\"1\",\"predistribution\":[{\"address\":\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"quota\":\"100000000000000000000\"}],\"maxblocksize\":\"128\",\"award\":\"1000000\",\"decimals\":\"8\",\"award_decay\":{\"height_gap\":31536000,\"ratio\":1},\"gas_price\":{\"cpu_rate\":1000,\"mem_rate\":1000000,\"disk_rate\":1,\"xfee_rate\":1},\"new_account_resource_amount\":1000,\"genesis_consensus\":{\"name\":\"single\",\"config\":{\"miner\":\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"period\":\"3000\"}}}","group":"{\"name\":\"hi\",\"admin\":[\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co\"],\"identities\":[\"SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co\"]}"}' --fee 10000000000
```

示例2：创链**tdpos共识**(可以不指定群组)

```shell
./bin/xchain-cli xkernel invoke '$parachain' --method createChain -a '{"name": "hi","data":"{\"version\": \"1\",\"predistribution\": [{\"address\": \"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"quota\": \"15000000000000000\"}],\"maxblocksize\": \"128\",\"award\": \"142690000\",\"decimals\": \"8\",\"award_decay\": {\"height_gap\": 31536000,\"ratio\": 1},\"nofee\": false,\"gas_price\": {\"cpu_rate\": 1000,\"mem_rate\": 1000000,\"disk_rate\": 1,\"xfee_rate\": 1},\"new_account_resource_amount\": 1000,\"genesis_consensus\": {\"name\": \"tdpos\",\"config\": {\"timestamp\": \"1559021720000000000\",\"proposer_num\": \"2\",\"period\": \"3000\",\"alternate_interval\": \"3000\",\"term_interval\": \"6000\",\"block_num\": \"30\",\"vote_unit_price\": \"1\",\"init_proposer\": {\"1\": [\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\", \"SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co\"]},\"init_proposer_neturl\": {\"1\": [\"/ip4/127.0.0.1/tcp/38101/p2p/Qmf2HeHe4sspGkfRCTq6257Vm3UHzvh2TeQJHHvHzzuFw6e\", \"/ip4/127.0.0.1/tcp/38102/p2p/QmQKp8pLWSgV4JiGjuULKV1JsdpxUtnDEUMP8sGaaUbwVL\"]}}},\"transfer_fee_amount\": 1000000}","group":"{\"name\":\"hi\",\"admin\":[\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\",\"SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co\"],\"identities\":[\"SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co\"]}"}' --fee 10000000000
```

其它共识只是配置信息不同
配置可在xuperchain/data/genesis/下查看（有poa.json/pow.json/tdpos.json/xpoa.json/xpos.json）

创建平行链时可以不显示指定群组配置，那么默认的**群组配置**就是如下：

```json
{
    "name": "平行链名字",
    "admin": [
        "发起者地址"
    ],
}
```

**2.3 停用平行链**

* 所有停用平行链按照如下格式
``` shell
./bin/xchain-cli xkernel invoke '$parachain' --method stopChain -a  {$BCNAME_CONFIG} --fee {$FEE} -H {$PORT} 
```
* 停用仅仅能群组的Admin管理员操作
* 停用仅仅是将平行链从xchain引擎中卸载，并不会删除账本，若账本不移走，重启后仍会被加载进引擎中
* 下面是一个停用hello链的例子
	
	``` shell
	./bin/xchain-cli  xkernel invoke '$parachain' --method stopChain -a '{"name":"hello"}' --fee 1000000
	```


**2.4 查看平行链的群组**
* 群组相关仍走三代kernel合约
* 下面是一个查看hello链群组的例子
``` shell
./bin/xchain-cli xkernel query '$parachain' --method getGroup -a '{"name":"hello"}'
```

**2.5 修改平行链的群组**
* 群组参数应按照下述json格式
	``` json
	{
    	"name": {$BCNAME},
      "admin": {$ADMINISTRATOR},
      "identities": {$IDENTITY}
	}
  ```

* 下面是一个修改群组的例子
	``` shell
	./bin/xchain-cli xkernel invoke '$parachain' --method editGroup -a '{"name":"hi","admin":"[\"TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY\"]"}' --fee 1000000
	```
	
	

Q&A

**1-定义联盟链时可以定义什么参数**

​	创建平行链时可以指定的参数：

​		1）name - 链名（不可与已有链重复）

​		2）data - 链的创世配置信息（主要有出块奖励、是否需要手续费模式、共识、出块间隔、转账手续费等）

​		3）group - 群组

​		群组参数说明：
​			name - 群组名（需与创建的链名一致）
​			admin - 管理员
​			identities - 成员

**2-管理员的权限是怎么样，能否修改**

​	管理员可以修改群组配置——增删管理员/成员，一条平行链只对该链的群组中指定的管理员/成员开放

**3-不创建群组时，是否都是开放给全网**

​	创链时如果不指定群组，系统会创建一个默认的群组，该群组中管理员为创建者，无成员——即该链只有创建者可视，不会开放给全网

**4-不同的共识机制创世需要配置什么参数**

​	不同的共识机制创世配置不一样

​	**共同参数：**

​		predistribution：预分配，创链后该参数下的address有quota数量的utxo，可以指定多个地址

​		maxblocksize：每个块最大大小（单位M）

​		award：出块奖励

​		award_decay：出块奖励递减策略，每到height_gap的倍数时，出块奖励变为原来的ratio倍

​		transfer_fee_amount：转账手续费

​	**部分共识的共同参数：**

​		period：出块间隔（单位毫秒）

​		block_num：轮到某个节点出块时，该节点的最多出块数量

​		init_proposer：初始默认出块节点

​		nofee：无需手续费模式

下面是示例配置：(整个作为创建链时参数的data)

xpoa共识

```json
{
    "version" : "1"
    , "predistribution":[
        {
            "address" : "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY"
            , "quota" : "100000000000000000000"
        }
    ]
    , "maxblocksize" : "128"
    , "award" : "1000000"
    , "decimals" : "8"
    , "award_decay": {
        "height_gap": 31536000,
        "ratio": 1
    }
        , "gas_price": {
        "cpu_rate": 1000,
        "mem_rate": 1000000,
        "disk_rate": 1,
        "xfee_rate": 1
    }
        , "new_account_resource_amount": 1000
        , "genesis_consensus":{
        "name": "xpoa",
        "config": {
                "period":3000,
                "block_num":10,
                "contract_name":"xpoa_validates",
                "method_name":"get_validates",
                "init_proposer": {
                    "address":[
                      "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY",
                      "SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co"            
                    ]
                },
		"bft_config": {}
           }
        }
    	, "transfer_fee_amount": 1000000
}
```

pow共识

```json
{
    "version" : "1"
    , "predistribution":[
        {
            "address" : "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY"
            , "quota" : "1000000000000000"
        }
    ]
    , "maxblocksize" : "128"
    , "award" : "1000000"
    , "decimals" : "8"
    , "award_decay": {
        "height_gap": 31536000,
        "ratio": 0.5
    }
    , "new_account_resource_amount": 1000
    , "genesis_consensus":{
       "name": "pow",
       "config": {
                        "defaultTarget": "545259519",
                        "adjustHeightGap": "5",
                        "expectedPeriod": "15",
                        "maxTarget": "486604799"
       }
    }
    , "transfer_fee_amount": 1000000
}
```

poa共识

```json
{
    "version" : "1"
    , "predistribution":[
        {
            "address" : "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY"
            , "quota" : "100000000000000000000"
        }
    ]
    , "maxblocksize" : "128"
    , "award" : "1000000"
    , "decimals" : "8"
    , "award_decay": {
        "height_gap": 31536000,
        "ratio": 1
    }
        , "gas_price": {
        "cpu_rate": 1000,
        "mem_rate": 1000000,
        "disk_rate": 1,
        "xfee_rate": 1
    }
        , "new_account_resource_amount": 1000
        , "genesis_consensus":{
        "name": "xpoa",
        "config": {
                "period":3000,
                "block_num":10,
                "contract_name":"xpoa_validates",
                "method_name":"get_validates",
                "init_proposer": {
                    "address":[
                      "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY",
                      "SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co"            
                    ]
                }
           }
        }
    , "transfer_fee_amount": 1000000
}
```

xpos共识

```json
{
    "version": "1",
    "predistribution": [
        {
            "address": "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY",
            "quota": "100000000000000000000"
        }
    ],
    "maxblocksize": "128",
    "award": "1000000",
    "decimals": "8",
    "award_decay": {
        "height_gap": 31536000,
        "ratio": 1
    },
    "nofee": false,
    "gas_price": {
        "cpu_rate": 1000,
        "mem_rate": 1000000,
        "disk_rate": 1,
        "xfee_rate": 1
    },
    "new_account_resource_amount": 1000,
    "genesis_consensus": {
        "name": "tdpos",
        "config": {
            "timestamp": "1559021720000000000",
            "proposer_num": "2",
            "period": "3000",
            "alternate_interval": "3000",
            "term_interval": "6000",
            "block_num": "20",
            "vote_unit_price": "1",
            "init_proposer": {
                "1": ["TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY", "SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co"]
            },
            "init_proposer_neturl": {
                "1": ["/ip4/127.0.0.1/tcp/38101/p2p/Qmf2HeHe4sspGkfRCTq6257Vm3UHzvh2TeQJHHvHzzuFw6e", "/ip4/127.0.0.1/tcp/38102/p2p/QmQKp8pLWSgV4JiGjuULKV1JsdpxUtnDEUMP8sGaaUbwVL"]
            },
            "bft_config": {}
        }
    },
    "transfer_fee_amount": 1000000
}
```

tdpos共识

```json
{
    "version": "1",
    "predistribution": [
        {
            "address": "TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY",
            "quota": "15000000000000000"
        }
    ],
    "maxblocksize": "128",
    "award": "142690000",
    "decimals": "8",
    "award_decay": {
        "height_gap": 31536000,
        "ratio": 1
    },
    "nofee": false,
    "gas_price": {
        "cpu_rate": 1000,
        "mem_rate": 1000000,
        "disk_rate": 1,
        "xfee_rate": 1
    },
    "new_account_resource_amount": 1000,
    "genesis_consensus": {
        "name": "tdpos",
        "config": {
            "timestamp": "1559021720000000000",
            "proposer_num": "2",
            "period": "3000",
            "alternate_interval": "3000",
            "term_interval": "6000",
            "block_num": "30",
            "vote_unit_price": "1",
            "init_proposer": {
                "1": ["TeyyPLpp9L7QAcxHangtcHTu7HUZ6iydY", "SmJG3rH2ZzYQ9ojxhbRCPwFiE9y6pD1Co"]
            },
            "init_proposer_neturl": {
                "1": ["/ip4/127.0.0.1/tcp/38101/p2p/Qmf2HeHe4sspGkfRCTq6257Vm3UHzvh2TeQJHHvHzzuFw6e", "/ip4/127.0.0.1/tcp/38102/p2p/QmQKp8pLWSgV4JiGjuULKV1JsdpxUtnDEUMP8sGaaUbwVL"]
            }
        }
    },
    "transfer_fee_amount": 1000000
}
```

